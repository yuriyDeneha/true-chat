import { Injectable } from '@angular/core';
import { Meta, Title } from '@angular/platform-browser';
import { from as observableFrom, of as observableOf } from 'rxjs';
import { MetaLoader } from './meta.loader';
import { PageTitlePositioning } from './models/page-title-positioning';
import { isObservable, isPromise } from './util';
var MetaService = (function () {
    function MetaService(loader, title, meta) {
        this.loader = loader;
        this.title = title;
        this.meta = meta;
        this.settings = loader.settings;
        this.isMetaTagSet = {};
    }
    MetaService.prototype.setTitle = function (title, override) {
        var _this = this;
        if (override === void 0) { override = false; }
        var title$ = title ? this.callback(title) : observableOf('');
        title$.subscribe(function (res) {
            var fullTitle = '';
            if (!res) {
                var defaultTitle$ = _this.settings.defaults && _this.settings.defaults.title ? _this.callback(_this.settings.defaults.title) : observableOf('');
                defaultTitle$.subscribe(function (defaultTitle) {
                    if (!override && _this.settings.pageTitleSeparator && _this.settings.applicationName) {
                        _this.callback(_this.settings.applicationName).subscribe(function (applicationName) {
                            fullTitle = applicationName ? _this.getTitleWithPositioning(defaultTitle, applicationName) : defaultTitle;
                            _this.updateTitle(fullTitle);
                        });
                    }
                    else {
                        _this.updateTitle(defaultTitle);
                    }
                });
            }
            else if (!override && _this.settings.pageTitleSeparator && _this.settings.applicationName) {
                _this.callback(_this.settings.applicationName).subscribe(function (applicationName) {
                    fullTitle = applicationName ? _this.getTitleWithPositioning(res, applicationName) : res;
                    _this.updateTitle(fullTitle);
                });
            }
            else {
                _this.updateTitle(res);
            }
        });
    };
    MetaService.prototype.setTag = function (key, value) {
        var _this = this;
        if (key === 'title') {
            throw new Error("Attempt to set " + key + " through \"setTag\": \"title\" is a reserved tag name. " + 'Please use `MetaService.setTitle` instead.');
        }
        var cur = value || (this.settings.defaults && this.settings.defaults[key] ? this.settings.defaults[key] : '');
        var value$ = key !== 'og:locale' && key !== 'og:locale:alternate' ? this.callback(cur) : observableOf(cur);
        value$.subscribe(function (res) {
            _this.updateTag(key, res);
        });
    };
    MetaService.prototype.update = function (currentUrl, metaSettings) {
        var _this = this;
        if (!metaSettings) {
            var fallbackTitle = this.settings.defaults
                ? this.settings.defaults.title || this.settings.applicationName
                : this.settings.applicationName;
            this.setTitle(fallbackTitle, true);
        }
        else {
            if (metaSettings.disabled) {
                this.update(currentUrl);
                return;
            }
            this.setTitle(metaSettings.title, metaSettings.override);
            Object.keys(metaSettings).forEach(function (key) {
                var value = metaSettings[key];
                if (key === 'title' || key === 'override') {
                    return;
                }
                else if (key === 'og:locale') {
                    value = value.replace(/-/g, '_');
                }
                else if (key === 'og:locale:alternate') {
                    var currentLocale = metaSettings['og:locale'];
                    _this.updateLocales(currentLocale, metaSettings[key]);
                    return;
                }
                _this.setTag(key, value);
            });
        }
        if (this.settings.defaults) {
            Object.keys(this.settings.defaults).forEach(function (key) {
                var value = _this.settings.defaults[key];
                if ((metaSettings && (key in _this.isMetaTagSet || key in metaSettings)) || key === 'title' || key === 'override') {
                    return;
                }
                else if (key === 'og:locale') {
                    value = value.replace(/-/g, '_');
                }
                else if (key === 'og:locale:alternate') {
                    var currentLocale = metaSettings ? metaSettings['og:locale'] : undefined;
                    _this.updateLocales(currentLocale, value);
                    return;
                }
                _this.setTag(key, value);
            });
        }
        var baseUrl = this.settings.applicationUrl ? this.settings.applicationUrl : '/';
        var url = ("" + baseUrl + currentUrl).replace(/(https?:\/\/)|(\/)+/g, '$1$2').replace(/\/$/g, '');
        this.setTag('og:url', url ? url : '/');
    };
    MetaService.prototype.removeTag = function (key) {
        this.meta.removeTag(key);
    };
    MetaService.prototype.callback = function (value) {
        if (this.settings.callback) {
            var value$ = this.settings.callback(value);
            if (!isObservable(value$)) {
                return isPromise(value$) ? observableFrom(value$) : observableOf(value$);
            }
            return value$;
        }
        return observableOf(value);
    };
    MetaService.prototype.getTitleWithPositioning = function (title, applicationName) {
        switch (this.settings.pageTitlePositioning) {
            case PageTitlePositioning.AppendPageTitle:
                return applicationName + String(this.settings.pageTitleSeparator) + title;
            case PageTitlePositioning.PrependPageTitle:
                return title + String(this.settings.pageTitleSeparator) + applicationName;
            default:
                throw new Error("Invalid pageTitlePositioning specified [" + this.settings.pageTitlePositioning + "]!");
        }
    };
    MetaService.prototype.updateTitle = function (title) {
        this.title.setTitle(title);
        this.meta.updateTag({
            property: 'og:title',
            content: title
        });
    };
    MetaService.prototype.updateLocales = function (currentLocale, availableLocales) {
        var _this = this;
        var cur = currentLocale || (this.settings.defaults ? this.settings.defaults['og:locale'] : '');
        if (cur && this.settings.defaults) {
            this.settings.defaults['og:locale'] = cur.replace(/_/g, '-');
        }
        var elements = this.meta.getTags('property="og:locale:alternate"');
        elements.forEach(function (element) {
            _this.meta.removeTagElement(element);
        });
        if (cur && availableLocales) {
            availableLocales.split(',').forEach(function (locale) {
                if (cur.replace(/-/g, '_') !== locale.replace(/-/g, '_')) {
                    _this.meta.addTag({
                        property: 'og:locale:alternate',
                        content: locale.replace(/-/g, '_')
                    });
                }
            });
        }
    };
    MetaService.prototype.updateTag = function (key, value) {
        if (key.lastIndexOf('og:', 0) === 0) {
            this.meta.updateTag({
                property: key,
                content: key === 'og:locale' ? value.replace(/-/g, '_') : value
            });
        }
        else {
            this.meta.updateTag({
                name: key,
                content: value
            });
        }
        this.isMetaTagSet[key] = true;
        if (key === 'description') {
            this.meta.updateTag({
                property: 'og:description',
                content: value
            });
        }
        else if (key === 'author') {
            this.meta.updateTag({
                property: 'og:author',
                content: value
            });
        }
        else if (key === 'publisher') {
            this.meta.updateTag({
                property: 'og:publisher',
                content: value
            });
        }
        else if (key === 'og:locale') {
            var availableLocales = this.settings.defaults ? this.settings.defaults['og:locale:alternate'] : '';
            this.updateLocales(value, availableLocales);
            this.isMetaTagSet['og:locale:alternate'] = true;
        }
        else if (key === 'og:locale:alternate') {
            var currentLocale = this.meta.getTag('property="og:locale"').content;
            this.updateLocales(currentLocale, value);
            this.isMetaTagSet['og:locale'] = true;
        }
    };
    MetaService.decorators = [
        { type: Injectable }
    ];
    MetaService.ctorParameters = function () { return [
        { type: MetaLoader },
        { type: Title },
        { type: Meta }
    ]; };
    return MetaService;
}());
export { MetaService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5neC1tZXRhL2NvcmUvIiwic291cmNlcyI6WyJzcmMvbWV0YS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsSUFBSSxJQUFJLGNBQWMsRUFBYyxFQUFFLElBQUksWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTlFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDdkUsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFakQ7SUFLRSxxQkFBcUIsTUFBa0IsRUFBbUIsS0FBWSxFQUFtQixJQUFVO1FBQTlFLFdBQU0sR0FBTixNQUFNLENBQVk7UUFBbUIsVUFBSyxHQUFMLEtBQUssQ0FBTztRQUFtQixTQUFJLEdBQUosSUFBSSxDQUFNO1FBQ2pHLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUNoQyxJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUQsOEJBQVEsR0FBUixVQUFTLEtBQWEsRUFBRSxRQUFnQjtRQUF4QyxpQkE2QkM7UUE3QnVCLHlCQUFBLEVBQUEsZ0JBQWdCO1FBQ3RDLElBQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRS9ELE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBQyxHQUFXO1lBQzNCLElBQUksU0FBUyxHQUFHLEVBQUUsQ0FB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SUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ2xCLFFBQVEsRUFBRSxXQUFXO2dCQUNyQixPQUFPLEVBQUUsS0FBSzthQUNmLENBQUMsQ0FBQztTQUNKO2FBQU0sSUFBSSxHQUFHLEtBQUssV0FBVyxFQUFFO1lBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNsQixRQUFRLEVBQUUsY0FBYztnQkFDeEIsT0FBTyxFQUFFLEtBQUs7YUFDZixDQUFDLENBQUM7U0FDSjthQUFNLElBQUksR0FBRyxLQUFLLFdBQVcsRUFBRTtZQUM5QixJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFFckcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUM1QyxJQUFJLENBQUMsWUFBWSxDQUFDLHFCQUFxQixDQUFDLEdBQUcsSUFBSSxDQUFDO1NBQ2pEO2FBQU0sSUFBSSxHQUFHLEtBQUsscUJBQXFCLEVBQUU7WUFDeEMsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFFdkUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDekMsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDdkM7SUFDSCxDQUFDOztnQkEvTkYsVUFBVTs7O2dCQUxGLFVBQVU7Z0JBSEosS0FBSztnQkFBWCxJQUFJOztJQXdPYixrQkFBQztDQUFBLEFBaE9ELElBZ09DO1NBL05ZLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1ldGEsIFRpdGxlIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XHJcbmltcG9ydCB7IGZyb20gYXMgb2JzZXJ2YWJsZUZyb20sIE9ic2VydmFibGUsIG9mIGFzIG9ic2VydmFibGVPZiB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgTWV0YUxvYWRlciB9IGZyb20gJy4vbWV0YS5sb2FkZXInO1xyXG5pbXBvcnQgeyBNZXRhU2V0dGluZ3MgfSBmcm9tICcuL21vZGVscy9tZXRhLXNldHRpbmdzJztcclxuaW1wb3J0IHsgUGFnZVRpdGxlUG9zaXRpb25pbmcgfSBmcm9tICcuL21vZGVscy9wYWdlLXRpdGxlLXBvc2l0aW9uaW5nJztcclxuaW1wb3J0IHsgaXNPYnNlcnZhYmxlLCBpc1Byb21pc2UgfSBmcm9tICcuL3V0aWwnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTWV0YVNlcnZpY2Uge1xyXG4gIHByb3RlY3RlZCByZWFkb25seSBzZXR0aW5nczogTWV0YVNldHRpbmdzO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgaXNNZXRhVGFnU2V0OiBhbnk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGxvYWRlcjogTWV0YUxvYWRlciwgcHJpdmF0ZSByZWFkb25seSB0aXRsZTogVGl0bGUsIHByaXZhdGUgcmVhZG9ubHkgbWV0YTogTWV0YSkge1xyXG4gICAgdGhpcy5zZXR0aW5ncyA9IGxvYWRlci5zZXR0aW5ncztcclxuICAgIHRoaXMuaXNNZXRhVGFnU2V0ID0ge307XHJcbiAgfVxyXG5cclxuICBzZXRUaXRsZSh0aXRsZTogc3RyaW5nLCBvdmVycmlkZSA9IGZhbHNlKTogdm9pZCB7XHJcbiAgICBjb25zdCB0aXRsZSQgPSB0aXRsZSA/IHRoaXMuY2FsbGJhY2sodGl0bGUpIDogb2JzZXJ2YWJsZU9mKCcnKTtcclxuXHJcbiAgICB0aXRsZSQuc3Vic2NyaWJlKChyZXM6IHN0cmluZykgPT4ge1xyXG4gICAgICBsZXQgZnVsbFRpdGxlID0gJyc7XHJcblxyXG4gICAgICBpZiAoIXJlcykge1xyXG4gICAgICAgIGNvbnN0IGRlZmF1bHRUaXRsZSQgPVxyXG4gICAgICAgICAgdGhpcy5zZXR0aW5ncy5kZWZhdWx0cyAmJiB0aGlzLnNldHRpbmdzLmRlZmF1bHRzLnRpdGxlID8gdGhpcy5jYWxsYmFjayh0aGlzLnNldHRpbmdzLmRlZmF1bHRzLnRpdGxlKSA6IG9ic2VydmFibGVPZignJyk7XHJcblxyXG4gICAgICAgIGRlZmF1bHRUaXRsZSQuc3Vic2NyaWJlKChkZWZhdWx0VGl0bGU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgaWYgKCFvdmVycmlkZSAmJiB0aGlzLnNldHRpbmdzLnBhZ2VUaXRsZVNlcGFyYXRvciAmJiB0aGlzLnNldHRpbmdzLmFwcGxpY2F0aW9uTmFtZSkge1xyXG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrKHRoaXMuc2V0dGluZ3MuYXBwbGljYXRpb25OYW1lKS5zdWJzY3JpYmUoKGFwcGxpY2F0aW9uTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgZnVsbFRpdGxlID0gYXBwbGljYXRpb25OYW1lID8gdGhpcy5nZXRUaXRsZVdpdGhQb3NpdGlvbmluZyhkZWZhdWx0VGl0bGUsIGFwcGxpY2F0aW9uTmFtZSkgOiBkZWZhdWx0VGl0bGU7XHJcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVUaXRsZShmdWxsVGl0bGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlVGl0bGUoZGVmYXVsdFRpdGxlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIGlmICghb3ZlcnJpZGUgJiYgdGhpcy5zZXR0aW5ncy5wYWdlVGl0bGVTZXBhcmF0b3IgJiYgdGhpcy5zZXR0aW5ncy5hcHBsaWNhdGlvbk5hbWUpIHtcclxuICAgICAgICB0aGlzLmNhbGxiYWNrKHRoaXMuc2V0dGluZ3MuYXBwbGljYXRpb25OYW1lKS5zdWJzY3JpYmUoKGFwcGxpY2F0aW9uTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBmdWxsVGl0bGUgPSBhcHBsaWNhdGlvbk5hbWUgPyB0aGlzLmdldFRpdGxlV2l0aFBvc2l0aW9uaW5nKHJlcywgYXBwbGljYXRpb25OYW1lKSA6IHJlcztcclxuICAgICAgICAgIHRoaXMudXBkYXRlVGl0bGUoZnVsbFRpdGxlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVRpdGxlKHJlcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2V0VGFnKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoa2V5ID09PSAndGl0bGUnKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICBgQXR0ZW1wdCB0byBzZXQgJHtrZXl9IHRocm91Z2ggXCJzZXRUYWdcIjogXCJ0aXRsZVwiIGlzIGEgcmVzZXJ2ZWQgdGFnIG5hbWUuIGAgKyAnUGxlYXNlIHVzZSBgTWV0YVNlcnZpY2Uuc2V0VGl0bGVgIGluc3RlYWQuJ1xyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGN1ciA9IHZhbHVlIHx8ICh0aGlzLnNldHRpbmdzLmRlZmF1bHRzICYmIHRoaXMuc2V0dGluZ3MuZGVmYXVsdHNba2V5XSA/IHRoaXMuc2V0dGluZ3MuZGVmYXVsdHNba2V5XSA6ICcnKTtcclxuXHJcbiAgICBjb25zdCB2YWx1ZSQgPSBrZXkgIT09ICdvZzpsb2NhbGUnICYmIGtleSAhPT0gJ29nOmxvY2FsZTphbHRlcm5hdGUnID8gdGhpcy5jYWxsYmFjayhjdXIpIDogb2JzZXJ2YWJsZU9mKGN1cik7XHJcblxyXG4gICAgdmFsdWUkLnN1YnNjcmliZSgocmVzOiBzdHJpbmcpID0+IHtcclxuICAgICAgdGhpcy51cGRhdGVUYWcoa2V5LCByZXMpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGUoY3VycmVudFVybDogc3RyaW5nLCBtZXRhU2V0dGluZ3M/OiBhbnkpOiB2b2lkIHtcclxuICAgIGlmICghbWV0YVNldHRpbmdzKSB7XHJcbiAgICAgIGNvbnN0IGZhbGxiYWNrVGl0bGUgPSB0aGlzLnNldHRpbmdzLmRlZmF1bHRzXHJcbiAgICAgICAgPyB0aGlzLnNldHRpbmdzLmRlZmF1bHRzLnRpdGxlIHx8IHRoaXMuc2V0dGluZ3MuYXBwbGljYXRpb25OYW1lXHJcbiAgICAgICAgOiB0aGlzLnNldHRpbmdzLmFwcGxpY2F0aW9uTmFtZTtcclxuXHJcbiAgICAgIHRoaXMuc2V0VGl0bGUoZmFsbGJhY2tUaXRsZSwgdHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAobWV0YVNldHRpbmdzLmRpc2FibGVkKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGUoY3VycmVudFVybCk7XHJcblxyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5zZXRUaXRsZShtZXRhU2V0dGluZ3MudGl0bGUsIG1ldGFTZXR0aW5ncy5vdmVycmlkZSk7XHJcblxyXG4gICAgICBPYmplY3Qua2V5cyhtZXRhU2V0dGluZ3MpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICBsZXQgdmFsdWUgPSBtZXRhU2V0dGluZ3Nba2V5XTtcclxuXHJcbiAgICAgICAgaWYgKGtleSA9PT0gJ3RpdGxlJyB8fCBrZXkgPT09ICdvdmVycmlkZScpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ29nOmxvY2FsZScpIHtcclxuICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvLS9nLCAnXycpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnb2c6bG9jYWxlOmFsdGVybmF0ZScpIHtcclxuICAgICAgICAgIGNvbnN0IGN1cnJlbnRMb2NhbGUgPSBtZXRhU2V0dGluZ3NbJ29nOmxvY2FsZSddO1xyXG4gICAgICAgICAgdGhpcy51cGRhdGVMb2NhbGVzKGN1cnJlbnRMb2NhbGUsIG1ldGFTZXR0aW5nc1trZXldKTtcclxuXHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnNldFRhZyhrZXksIHZhbHVlKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuc2V0dGluZ3MuZGVmYXVsdHMpIHtcclxuICAgICAgT2JqZWN0LmtleXModGhpcy5zZXR0aW5ncy5kZWZhdWx0cykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuc2V0dGluZ3MuZGVmYXVsdHNba2V5XTtcclxuXHJcbiAgICAgICAgaWYgKChtZXRhU2V0dGluZ3MgJiYgKGtleSBpbiB0aGlzLmlzTWV0YVRhZ1NldCB8fCBrZXkgaW4gbWV0YVNldHRpbmdzKSkgfHwga2V5ID09PSAndGl0bGUnIHx8IGtleSA9PT0gJ292ZXJyaWRlJykge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnb2c6bG9jYWxlJykge1xyXG4gICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC8tL2csICdfJyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdvZzpsb2NhbGU6YWx0ZXJuYXRlJykge1xyXG4gICAgICAgICAgY29uc3QgY3VycmVudExvY2FsZSA9IG1ldGFTZXR0aW5ncyA/IG1ldGFTZXR0aW5nc1snb2c6bG9jYWxlJ10gOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICB0aGlzLnVwZGF0ZUxvY2FsZXMoY3VycmVudExvY2FsZSwgdmFsdWUpO1xyXG5cclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuc2V0VGFnKGtleSwgdmFsdWUpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBiYXNlVXJsID0gdGhpcy5zZXR0aW5ncy5hcHBsaWNhdGlvblVybCA/IHRoaXMuc2V0dGluZ3MuYXBwbGljYXRpb25VcmwgOiAnLyc7XHJcbiAgICBjb25zdCB1cmwgPSBgJHtiYXNlVXJsfSR7Y3VycmVudFVybH1gLnJlcGxhY2UoLyhodHRwcz86XFwvXFwvKXwoXFwvKSsvZywgJyQxJDInKS5yZXBsYWNlKC9cXC8kL2csICcnKTtcclxuXHJcbiAgICB0aGlzLnNldFRhZygnb2c6dXJsJywgdXJsID8gdXJsIDogJy8nKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZVRhZyhrZXk6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5tZXRhLnJlbW92ZVRhZyhrZXkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjYWxsYmFjayh2YWx1ZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcclxuICAgIGlmICh0aGlzLnNldHRpbmdzLmNhbGxiYWNrKSB7XHJcbiAgICAgIGNvbnN0IHZhbHVlJCA9IHRoaXMuc2V0dGluZ3MuY2FsbGJhY2sodmFsdWUpO1xyXG5cclxuICAgICAgaWYgKCFpc09ic2VydmFibGUodmFsdWUkKSkge1xyXG4gICAgICAgIHJldHVybiBpc1Byb21pc2UodmFsdWUkKSA/IG9ic2VydmFibGVGcm9tKHZhbHVlJCkgOiBvYnNlcnZhYmxlT2YodmFsdWUkKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHZhbHVlJDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gb2JzZXJ2YWJsZU9mKHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0VGl0bGVXaXRoUG9zaXRpb25pbmcodGl0bGU6IHN0cmluZywgYXBwbGljYXRpb25OYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgc3dpdGNoICh0aGlzLnNldHRpbmdzLnBhZ2VUaXRsZVBvc2l0aW9uaW5nKSB7XHJcbiAgICAgIGNhc2UgUGFnZVRpdGxlUG9zaXRpb25pbmcuQXBwZW5kUGFnZVRpdGxlOlxyXG4gICAgICAgIHJldHVybiBhcHBsaWNhdGlvbk5hbWUgKyBTdHJpbmcodGhpcy5zZXR0aW5ncy5wYWdlVGl0bGVTZXBhcmF0b3IpICsgdGl0bGU7XHJcbiAgICAgIGNhc2UgUGFnZVRpdGxlUG9zaXRpb25pbmcuUHJlcGVuZFBhZ2VUaXRsZTpcclxuICAgICAgICByZXR1cm4gdGl0bGUgKyBTdHJpbmcodGhpcy5zZXR0aW5ncy5wYWdlVGl0bGVTZXBhcmF0b3IpICsgYXBwbGljYXRpb25OYW1lO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwYWdlVGl0bGVQb3NpdGlvbmluZyBzcGVjaWZpZWQgWyR7dGhpcy5zZXR0aW5ncy5wYWdlVGl0bGVQb3NpdGlvbmluZ31dIWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVUaXRsZSh0aXRsZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnRpdGxlLnNldFRpdGxlKHRpdGxlKTtcclxuICAgIHRoaXMubWV0YS51cGRhdGVUYWcoe1xyXG4gICAgICBwcm9wZXJ0eTogJ29nOnRpdGxlJyxcclxuICAgICAgY29udGVudDogdGl0bGVcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVMb2NhbGVzKGN1cnJlbnRMb2NhbGU6IHN0cmluZywgYXZhaWxhYmxlTG9jYWxlczogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCBjdXIgPSBjdXJyZW50TG9jYWxlIHx8ICh0aGlzLnNldHRpbmdzLmRlZmF1bHRzID8gdGhpcy5zZXR0aW5ncy5kZWZhdWx0c1snb2c6bG9jYWxlJ10gOiAnJyk7XHJcblxyXG4gICAgaWYgKGN1ciAmJiB0aGlzLnNldHRpbmdzLmRlZmF1bHRzKSB7XHJcbiAgICAgIHRoaXMuc2V0dGluZ3MuZGVmYXVsdHNbJ29nOmxvY2FsZSddID0gY3VyLnJlcGxhY2UoL18vZywgJy0nKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUT0RPOiBzZXQgSFRNTCBsYW5nIGF0dHJpYnV0ZSAtIGh0dHBzOi8vZ2l0aHViLmNvbS9uZ3gtbWV0YS9jb3JlL2lzc3Vlcy8zMlxyXG4gICAgLy8gY29uc3QgaHRtbCA9IHRoaXMuZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaHRtbCcpO1xyXG4gICAgLy8gaHRtbC5zZXRBdHRyaWJ1dGUoJ2xhbmcnLCBjdXIpO1xyXG5cclxuICAgIGNvbnN0IGVsZW1lbnRzID0gdGhpcy5tZXRhLmdldFRhZ3MoJ3Byb3BlcnR5PVwib2c6bG9jYWxlOmFsdGVybmF0ZVwiJyk7XHJcblxyXG4gICAgZWxlbWVudHMuZm9yRWFjaCgoZWxlbWVudDogYW55KSA9PiB7XHJcbiAgICAgIHRoaXMubWV0YS5yZW1vdmVUYWdFbGVtZW50KGVsZW1lbnQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKGN1ciAmJiBhdmFpbGFibGVMb2NhbGVzKSB7XHJcbiAgICAgIGF2YWlsYWJsZUxvY2FsZXMuc3BsaXQoJywnKS5mb3JFYWNoKChsb2NhbGU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGlmIChjdXIucmVwbGFjZSgvLS9nLCAnXycpICE9PSBsb2NhbGUucmVwbGFjZSgvLS9nLCAnXycpKSB7XHJcbiAgICAgICAgICB0aGlzLm1ldGEuYWRkVGFnKHtcclxuICAgICAgICAgICAgcHJvcGVydHk6ICdvZzpsb2NhbGU6YWx0ZXJuYXRlJyxcclxuICAgICAgICAgICAgY29udGVudDogbG9jYWxlLnJlcGxhY2UoLy0vZywgJ18nKVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlVGFnKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoa2V5Lmxhc3RJbmRleE9mKCdvZzonLCAwKSA9PT0gMCkge1xyXG4gICAgICB0aGlzLm1ldGEudXBkYXRlVGFnKHtcclxuICAgICAgICBwcm9wZXJ0eToga2V5LFxyXG4gICAgICAgIGNvbnRlbnQ6IGtleSA9PT0gJ29nOmxvY2FsZScgPyB2YWx1ZS5yZXBsYWNlKC8tL2csICdfJykgOiB2YWx1ZVxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMubWV0YS51cGRhdGVUYWcoe1xyXG4gICAgICAgIG5hbWU6IGtleSxcclxuICAgICAgICBjb250ZW50OiB2YWx1ZVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmlzTWV0YVRhZ1NldFtrZXldID0gdHJ1ZTtcclxuXHJcbiAgICBpZiAoa2V5ID09PSAnZGVzY3JpcHRpb24nKSB7XHJcbiAgICAgIHRoaXMubWV0YS51cGRhdGVUYWcoe1xyXG4gICAgICAgIHByb3BlcnR5OiAnb2c6ZGVzY3JpcHRpb24nLFxyXG4gICAgICAgIGNvbnRlbnQ6IHZhbHVlXHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdhdXRob3InKSB7XHJcbiAgICAgIHRoaXMubWV0YS51cGRhdGVUYWcoe1xyXG4gICAgICAgIHByb3BlcnR5OiAnb2c6YXV0aG9yJyxcclxuICAgICAgICBjb250ZW50OiB2YWx1ZVxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSBpZiAoa2V5ID09PSAncHVibGlzaGVyJykge1xyXG4gICAgICB0aGlzLm1ldGEudXBkYXRlVGFnKHtcclxuICAgICAgICBwcm9wZXJ0eTogJ29nOnB1Ymxpc2hlcicsXHJcbiAgICAgICAgY29udGVudDogdmFsdWVcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ29nOmxvY2FsZScpIHtcclxuICAgICAgY29uc3QgYXZhaWxhYmxlTG9jYWxlcyA9IHRoaXMuc2V0dGluZ3MuZGVmYXVsdHMgPyB0aGlzLnNldHRpbmdzLmRlZmF1bHRzWydvZzpsb2NhbGU6YWx0ZXJuYXRlJ10gOiAnJztcclxuXHJcbiAgICAgIHRoaXMudXBkYXRlTG9jYWxlcyh2YWx1ZSwgYXZhaWxhYmxlTG9jYWxlcyk7XHJcbiAgICAgIHRoaXMuaXNNZXRhVGFnU2V0WydvZzpsb2NhbGU6YWx0ZXJuYXRlJ10gPSB0cnVlO1xyXG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdvZzpsb2NhbGU6YWx0ZXJuYXRlJykge1xyXG4gICAgICBjb25zdCBjdXJyZW50TG9jYWxlID0gdGhpcy5tZXRhLmdldFRhZygncHJvcGVydHk9XCJvZzpsb2NhbGVcIicpLmNvbnRlbnQ7XHJcblxyXG4gICAgICB0aGlzLnVwZGF0ZUxvY2FsZXMoY3VycmVudExvY2FsZSwgdmFsdWUpO1xyXG4gICAgICB0aGlzLmlzTWV0YVRhZ1NldFsnb2c6bG9jYWxlJ10gPSB0cnVlO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=